{% extends "complaints/base.html" %}

{% block content %}
<section class="page-head">
  <div>
    <h1>{{ ticket.subject }}</h1>
    <div class="meta">
      <span class="pill type">{{ ticket.get_type_display }}</span>
      <span class="pill priority">{{ ticket.get_priority_display }}</span>
      <span class="pill status {{ ticket.status }}">{{ ticket.get_status_display }}</span>
      <span class="pill category">{{ ticket.category.name }}</span>
      {% if ticket.is_anonymous %}
        <span class="pill">Anonymous</span>
      {% endif %}
    </div>
  </div>
  <a href="{% url 'index' %}" class="btn ghost">Back</a>
</section>

<div class="card">
  <div class="card-title">Request details</div>
  <p class="small">
    From
    {% if ticket.is_anonymous %}
      Anonymous
    {% else %}
      {{ ticket.name }} Â· {{ ticket.email }}
    {% endif %}
  </p>
  <p>{{ ticket.message }}</p>
</div>

{% if ticket.answer %}
  <div class="card accent">
    <div class="card-title">Admin response</div>
    <p>{{ ticket.answer }}</p>
  </div>
{% endif %}

<div class="card">
  <div class="card-title">Ratings</div>
  {% if avg_rating %}
    <p class="small">Average rating: {{ avg_rating|floatformat:1 }}/5</p>
  {% else %}
    <p class="small">No ratings yet.</p>
  {% endif %}

  <form method="post" action="{% url 'rate_ticket' ticket.id %}">
    {% csrf_token %}
    {{ rating_form.as_p }}
    <button type="submit" class="btn primary">Submit rating</button>
  </form>

  {% if ratings %}
    <div class="news-list" style="margin-top:12px;">
      {% for r in ratings %}
        <div class="news-item">
          <span class="news-tag">{{ r.score }}/5</span>
          <div>
            <div class="news-title">{{ r.rater_name|default:"Anonymous" }}</div>
            <div class="small">{{ r.comment }}</div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
</div>
{% endblock %}
