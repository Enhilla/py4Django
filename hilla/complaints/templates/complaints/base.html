{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Support{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Fraunces:opsz,wght@9..144,600;9..144,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'complaints/style.css' %}">
</head>
<body class="theme">
<div class="bg-orbit"></div>

<header class="topbar">
    <div class="container">
        <a class="brand" href="{% url 'index' %}">FixMyCampus</a>
        <nav class="nav">
            <a href="{% url 'create' %}">Create ticket</a>
            <a href="{% url 'dashboard' %}">Dashboard</a>
            <a href="{% url 'api_tickets' %}" target="_blank">API</a>
            <a href="/admin/">Admin</a>
            {% if request.user.is_staff %}
              <a href="{% url 'admin_queue' %}">Moderation</a>
            {% endif %}
            {% if request.user.is_superuser %}
              <a href="{% url 'create_admin' %}">Create admin</a>
              <a href="{% url 'seed_demo' %}">Seed demo</a>
            {% endif %}
            {% if request.user.is_authenticated %}
              <div class="user-menu">
                <button type="button" class="user-avatar" data-user-menu>
                  {% if request.user.profile.avatar %}
                    <img src="{{ request.user.profile.avatar.url }}" alt="Avatar">
                  {% else %}
                    <span>{{ request.user.username|first|upper }}</span>
                  {% endif %}
                </button>
                <div class="user-dropdown" hidden>
                  <a href="{% url 'account' %}">My account</a>
                  <form method="post" action="{% url 'logout' %}">
                    {% csrf_token %}
                    <button type="submit" class="logout-link">Logout</button>
                  </form>
                </div>
              </div>
            {% else %}
              <a href="{% url 'login' %}">Login</a>
              <a href="{% url 'signup' %}">Sign up</a>
            {% endif %}
        </nav>
    </div>
</header>

<main class="container page-transition-target">
    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="message {{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}

    {% block content %}{% endblock %}
</main>

<footer class="site-footer">
  <div class="footer-rule"></div>
  <div class="container footer-grid">
    <div>
      <div class="footer-brand">FixMyCampus</div>
      <p class="small">Built as a civic-style support tracker for campus issues.</p>
    </div>
    <div>
      <div class="footer-title">Social</div>
      <div class="footer-icons">
        <a class="icon-link" href="https://github.com/Enhilla" target="_blank" rel="noopener" aria-label="GitHub">
          <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
            <path d="M12 .5a12 12 0 0 0-3.8 23.4c.6.1.8-.2.8-.6v-2.1c-3.3.7-4-1.6-4-1.6-.5-1.3-1.3-1.7-1.3-1.7-1.1-.7.1-.7.1-.7 1.2.1 1.9 1.2 1.9 1.2 1.1 1.9 2.9 1.4 3.6 1.1.1-.8.4-1.4.7-1.7-2.6-.3-5.3-1.3-5.3-5.7 0-1.2.4-2.2 1.1-3-.1-.3-.5-1.5.1-3.1 0 0 .9-.3 3.1 1.1a10.7 10.7 0 0 1 5.6 0c2.2-1.4 3.1-1.1 3.1-1.1.6 1.6.2 2.8.1 3.1.7.8 1.1 1.8 1.1 3 0 4.4-2.7 5.4-5.3 5.7.4.4.8 1.1.8 2.3v3.4c0 .4.2.7.8.6A12 12 0 0 0 12 .5Z"/>
          </svg>
        </a>
        <a class="icon-link" href="https://www.instagram.com/enhillahgel/" target="_blank" rel="noopener" aria-label="Instagram">
          <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
            <path d="M7 3h10a4 4 0 0 1 4 4v10a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4V7a4 4 0 0 1 4-4Zm10 2H7a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Zm-5 3.5A5.5 5.5 0 1 1 6.5 14 5.5 5.5 0 0 1 12 8.5Zm0 2A3.5 3.5 0 1 0 15.5 14 3.5 3.5 0 0 0 12 10.5Zm6-3.4a1.1 1.1 0 1 1-1.1 1.1A1.1 1.1 0 0 1 18 7.1Z"/>
          </svg>
        </a>
      </div>
    </div>
    <div>
      <div class="footer-title">Project</div>
      <div class="footer-links">
        <a href="{% url 'create' %}">Create request</a>
        <a href="{% url 'index' %}">All tickets</a>
      </div>
    </div>
  </div>
  <div class="footer-bottom"></div>
</footer>

<div class="toast" id="toast" aria-live="polite" aria-atomic="true"></div>

<script>
  (function () {
    const toast = document.getElementById("toast");
    const showToast = (text) => {
      if (!toast) return;
      toast.textContent = text;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2400);
    };

    const openLayer = (el) => {
      if (!el) return;
      el.removeAttribute("hidden");
      el.classList.add("open");
      if (el.classList.contains("modal")) {
        document.body.classList.add("modal-open");
      }
    };

    const closeLayer = (el, withToast = false) => {
      if (!el) return;
      el.classList.remove("open");
      el.setAttribute("hidden", "hidden");
      if (el.classList.contains("modal")) {
        document.body.classList.remove("modal-open");
      }
      if (withToast) showToast("Closed");
    };

    document.addEventListener("click", (e) => {
      const trigger = e.target.closest("[data-modal-open]");
      const closeBtn = e.target.closest("[data-modal-close]");
      const copyBtn = e.target.closest("[data-copy-target]");
      const popoverClose = e.target.closest("[data-popover-close]");
      const aiBtn = e.target.closest("[data-ai-action]");
      const overlay = e.target.classList.contains("modal") ? e.target : null;
      const aiBackdrop = e.target.id === "ai-backdrop" ? e.target : null;
      const userMenuBtn = e.target.closest("[data-user-menu]");
      const userMenu = userMenuBtn ? userMenuBtn.closest(".user-menu") : null;

      if (trigger) {
        const id = trigger.getAttribute("data-modal-open");
        const modal = document.getElementById(id);
        openLayer(modal);
        if (id === "modal-ai") {
          const backdrop = document.getElementById("ai-backdrop");
          openLayer(backdrop);
        }
      }

      if (closeBtn) {
        const modal = closeBtn.closest(".modal");
        closeLayer(modal, true);
      }

      if (overlay) {
        closeLayer(overlay);
      }

      if (popoverClose) {
        const popover = popoverClose.closest(".ai-popover");
        closeLayer(popover);
        const backdrop = document.getElementById("ai-backdrop");
        closeLayer(backdrop);
      }

      if (aiBackdrop) {
        const popover = document.getElementById("modal-ai");
        closeLayer(popover);
        closeLayer(aiBackdrop);
      }

      if (userMenuBtn && userMenu) {
        const dropdown = userMenu.querySelector(".user-dropdown");
        if (dropdown) {
          dropdown.toggleAttribute("hidden");
        }
      } else {
        document.querySelectorAll(".user-dropdown:not([hidden])").forEach((d) => d.setAttribute("hidden", "hidden"));
      }

      if (copyBtn) {
        const targetId = copyBtn.getAttribute("data-copy-target");
        const target = targetId ? document.getElementById(targetId) : null;
        if (target && target.value) {
          navigator.clipboard.writeText(target.value).then(() => showToast("Copied to clipboard."));
        }
      }

      if (aiBtn) {
        const mode = aiBtn.getAttribute("data-ai-action");
        const targetId = aiBtn.getAttribute("data-ai-target");
        const target = targetId ? document.getElementById(targetId) : null;
        if (!target || !target.value.trim()) {
          showToast("Add a short description first.");
          return;
        }
        showToast("Generating...");
        fetch("{% url 'api_ai_generate' %}", {
          method: "POST",
          credentials: "same-origin",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": (function () {
              const match = document.cookie.match(/csrftoken=([^;]+)/);
              return match ? match[1] : "";
            })()
          },
          body: JSON.stringify({ mode, text: target.value })
        })
          .then((r) => r.json().then((data) => ({ ok: r.ok, data })))
          .then(({ ok, data }) => {
            if (!ok) {
              showToast(data.user_message || data.error || "AI error");
              return;
            }
            target.value = data.text || "";
            showToast("Done.");
          })
          .catch(() => showToast("Network error"));
      }
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        document.querySelectorAll(".modal.open").forEach((m) => closeLayer(m));
        document.querySelectorAll(".ai-popover.open").forEach((p) => closeLayer(p));
        const backdrop = document.getElementById("ai-backdrop");
        closeLayer(backdrop);
      }
    });

    document.querySelectorAll("[data-prompt-template]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const targetId = btn.getAttribute("data-target");
        const target = targetId ? document.getElementById(targetId) : null;
        if (!target) return;
        target.value = btn.getAttribute("data-prompt-template") || "";
        showToast("Prompt template inserted.");
      });
    });

    const isInternalLink = (href) => {
      if (!href) return false;
      if (href.startsWith("#") || href.startsWith("mailto:") || href.startsWith("tel:")) return false;
      return href.startsWith("/") || href.startsWith(window.location.origin);
    };

    document.addEventListener("click", (e) => {
      const link = e.target.closest("a[href]");
      if (!link) return;

      const href = link.getAttribute("href");
      if (
        !isInternalLink(href) ||
        link.target === "_blank" ||
        link.hasAttribute("download") ||
        e.metaKey ||
        e.ctrlKey ||
        e.shiftKey ||
        e.altKey
      ) {
        return;
      }

      const url = new URL(link.href, window.location.href);
      if (url.origin !== window.location.origin) return;
      if (url.pathname === window.location.pathname && url.search === window.location.search) return;
      if (link.closest(".user-dropdown")) return;

      e.preventDefault();
      document.body.classList.add("page-leaving");
      setTimeout(() => {
        window.location.href = url.toString();
      }, 180);
    });
  })();
</script>
</body>
</html>
